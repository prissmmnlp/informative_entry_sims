---
title: "Supplemental data"
output:
  html_document:
    df_print: default
  html_notebook: default
  pdf_document: default
  word_document: default
---

<style type="text/css">
  body{
  font-size: 16pt;
}
</style>

## Setup

```{r}

rm(list=ls())
oldw <- getOption("warn")
options(warn = -1)

library(ggplot2)
library(ggpubr)
library(survival)
library(survminer)
library(dplyr)
library(foreach)
library(doParallel)
library(tibble)
library(readr)
library(tranSurv)
library(patchwork)
library(depend.truncation)





set.seed(42)
```




Define function used to evaluate output from simulations and derive observed minus true OS, conditional Kendall's tau, Cox coeffcient for time, and Cox coefficient for biomarker effect within a cohort:
```{r}
eval_simple <- function(surv_times, died, testing_times, observed_surv_times, observed_died, observed_testing_times, biomarker_statuses, observed_biomarker_statuses, do_transurv=TRUE, do_copula=TRUE){
  
    os_true_median <- tryCatch({
      os_true_survfit <- survfit(Surv(surv_times, died) ~ 1)
      unname(summary(os_true_survfit)$table['median'])
    }, error = function(cond) {return(NA)})

    os_observed_median <- tryCatch({
      os_observed_survfit <- survfit(Surv(observed_testing_times, observed_surv_times, observed_died) ~ 1)
      unname(summary(os_observed_survfit)$table['median'])
    }, error = function(cond) {return(NA)})    
    
    

    #ckendall_run = tryCatch({
    #  cKendall(observed_testing_times, observed_surv_times, observed_died) 
    #}, error = function(cond) {return(NA)})
    
    if(do_transurv){
      trans_fit = tryCatch({
      trSurvfit(observed_testing_times, observed_surv_times, observed_died, tFun='linear', plots=FALSE)
    }, error = function(cond) {return(NA)})} else NA
    
    if(do_transurv){os_transfit_median <- tryCatch({
      temp = trans_fit$surv %>% mutate(diff_from_median = abs(trSurv - 0.5)) %>% filter(diff_from_median == min(diff_from_median))
      temp$Time
    }, error = function(cond) {return(NA)}) } else os_transfit_median=NA
    
    
    if(do_transurv){trans_fit_exp = tryCatch({
      trSurvfit(observed_testing_times, observed_surv_times, observed_died, tFun='exp', plots=FALSE)
    }, error = function(cond) {return(NA)})} else NA
    
    if(do_transurv){os_transfitexp_median <- tryCatch({
      temp = trans_fit$surv %>% mutate(diff_from_median = abs(trSurv - 0.5)) %>% filter(diff_from_median == min(diff_from_median))
      temp$Time
    }, error = function(cond) {return(NA)})} else os_transfitexp_median=NA
    
    if(do_transurv){
      surv_obj = tryCatch({trReg(Surv(observed_testing_times, observed_surv_times, observed_died) ~ observed_biomarker_statuses)}, error = function(cond) {return(NA)})
      transfit_biomarker_coef = tryCatch({surv_obj$PE[1]}, error=function(cond) {return(NA)})
      transfit_trans_param = tryCatch({surv_obj$a}, error=function(cond) {return(NA)})
    } else {
      transfit_biomarker_coef=NA
      transfit_trans_param = NA
    }
    
    
    if(do_copula){os_copula_median <- tryCatch({
      temp_data <- as_tibble(cbind(observed_testing_times, observed_surv_times, observed_died)) %>% arrange(observed_surv_times)
      copula = CHAIEB.Clayton(observed_testing_times, observed_surv_times, observed_died)
      temp_data$copula_surv = copula$Sy 
      temp_data <- temp_data %>% mutate(diff_from_median = abs(copula_surv - 0.5)) %>% filter(diff_from_median == min(diff_from_median))
      temp_data$observed_surv_times[1]
    #})
    }, error = function(cond) {return(NA)}) } else os_copula_median=NA
    

    #tranSurv::cKendall(genomic_testing_times, survival_times, event_indicator)
    
    
    time_tvc_run = tryCatch({
      summary(coxph(Surv(observed_testing_times, observed_surv_times, observed_died) ~ observed_testing_times))
    }, error = function(cond) {return(NA)})
    
    
    #coxph(Surv(genomic_testing_times, survival_times, event_indicator) ~ genomic_testing_times, data=dataset)
    
    
    
    time_cox_coef = tryCatch({
      time_tvc_run$coefficients[1]
    }, error = function(cond) {return(NA)})
    
    
    biomarker_run = tryCatch({
      summary(coxph(Surv(observed_testing_times, observed_surv_times, observed_died) ~ observed_biomarker_statuses))
    }, error = function(cond) {return(NA)})
    
    
    observed_biomarker_coef = tryCatch({
      biomarker_run$coefficients[1]
    }, error = function(cond) {return(NA)})
    
    observed_biomarker_p = tryCatch({
      biomarker_run$coefficients[5]
    }, error = function(cond) {return(NA)})    
    
    
    
    
    
    biomarker_run = tryCatch({
      summary(coxph(Surv(surv_times, died) ~ biomarker_statuses))
    }, error = function(cond) {return(NA)})
    
    
    true_biomarker_coef = tryCatch({
      biomarker_run$coefficients[1]
    }, error = function(cond) {return(NA)})    
    
    true_biomarker_p = tryCatch({
      biomarker_run$coefficients[5]
    }, error = function(cond) {return(NA)})       
    
    
    
    equal_true_sample_index = sample(c(1:length(surv_times)), length(observed_testing_times))
    surv_times_observedsize = surv_times[equal_true_sample_index]
    died_observedsize = died[equal_true_sample_index]
    biomarker_statuses_observedsize = biomarker_statuses[equal_true_sample_index]
    
    biomarker_run = tryCatch({
      summary(coxph(Surv(surv_times_observedsize, died_observedsize) ~ biomarker_statuses_observedsize))
    }, error = function(cond) {return(NA)})    
    
    true_biomarker_p_observedsize = tryCatch({
      biomarker_run$coefficients[5]
    }, error = function(cond) {return(NA)})       
    
    
    
    biomarker_run = tryCatch({
      summary(coxph(Surv(observed_testing_times, observed_surv_times, observed_died) ~ observed_biomarker_statuses + observed_testing_times))
    }, error = function(cond) {return(NA)})
    
    
    
    
    observed_biomarker_coef_withtime = tryCatch({
      biomarker_run$coefficients[2]
    }, error = function(cond) {return(NA)})
    
    
    if(do_transurv){kendalls = tryCatch({trans_fit$iniKendall}, error = function(cond) {return(NA)})}
    else {
          kendalls = tryCatch({
          cKendall(observed_testing_times, observed_surv_times, method="IPW1")$PE 
    }, error = function(cond) {return(NA)})
    }
    
    observed_minus_true = os_observed_median - os_true_median
    transfit_minus_true = os_transfit_median - os_true_median
    transfitexp_minus_true = os_transfitexp_median - os_true_median
    copulafit_minus_true = os_copula_median - os_true_median

    cox_coefs = time_cox_coef
    return(bind_cols(os_observed_median = os_observed_median, os_true_median=os_true_median, os_transfitexp_median = os_transfitexp_median, os_transfit_median=os_transfit_median, observed_minus_true=observed_minus_true, transfit_minus_true=transfit_minus_true, transfitexp_minus_true=transfitexp_minus_true, copulafit_minus_true=copulafit_minus_true, kendalls=kendalls, cox_coefs=cox_coefs, true_biomarker_coef=true_biomarker_coef, true_biomarker_p=true_biomarker_p, true_biomarker_p_observedsize=true_biomarker_p_observedsize, observed_biomarker_coef=observed_biomarker_coef, observed_biomarker_p=observed_biomarker_p, transfit_biomarker_coef=transfit_biomarker_coef, transfit_trans_param=transfit_trans_param, observed_biomarker_coef_withtime=observed_biomarker_coef_withtime))
  
  
}
```






Scenario #1: Survival time is exponentially distributed from an index date, genomic testing time is uniformly distributed from an index date. This yields null values for conditional Kendall's tau and the Cox coefficient for entry time; and unbiased survival times and biomarker effects.
```{r, fig.show='hold', message=FALSE,  fig.keep='all'}
# Scenario #1

oldw <- getOption("warn")
options(warn = -1)

cl = makeCluster(detectCores() - 1)
registerDoParallel(cl)

num_cohorts = 100000

results = foreach(i =c(1:num_cohorts), .export=ls(.GlobalEnv), .packages=c('dplyr','foreach','survival','tranSurv','depend.truncation')) %dopar% {

  hazard_rate = runif(1, min=0.005, max=0.03)
  
  num_patients_per_cohort = as.integer(runif(1, min=50, max=5000))
  
  
  biomarker_rate_ratio = runif(1, min=0.1, max=3)
  biomarker_prevalence = runif(1,0.05,0.5)
  biomarker_statuses = rbinom(num_patients_per_cohort, 1, biomarker_prevalence)

  
  
  final_rates = hazard_rate + hazard_rate*biomarker_statuses*biomarker_rate_ratio
  
  
  surv_times = rexp(num_patients_per_cohort, rate=final_rates)
  
  testing_times = runif(num_patients_per_cohort, 0, 12)
  testing_times = pmax(0, testing_times)

  censoring_times = runif(num_patients_per_cohort, 0, 120)
  
  died = ifelse(surv_times < censoring_times, 1, 0)
  surv_times = pmin(surv_times, censoring_times)

  
  
  
  observed_surv_times = surv_times[surv_times > testing_times]
  observed_died = died[surv_times > testing_times]
  observed_testing_times = testing_times[surv_times > testing_times]
  observed_biomarker_statuses = biomarker_statuses[surv_times > testing_times]

  do_copula = FALSE
  do_transurv = FALSE

    bind_cols(num_patients_per_cohort=num_patients_per_cohort, num_patients_observed=length(observed_died), hazard_rate=hazard_rate, biomarker_rate_ratio=biomarker_rate_ratio, biomarker_prevalence=biomarker_prevalence, eval_simple(surv_times = surv_times, died=died, testing_times=testing_times, observed_surv_times = observed_surv_times, observed_died=observed_died, observed_testing_times = observed_testing_times, biomarker_statuses = biomarker_statuses, observed_biomarker_statuses = observed_biomarker_statuses, do_transurv = do_transurv, do_copula = do_copula))
  
}

registerDoSEQ()  
stopCluster(cl)


options(warn = oldw)

results = bind_rows(results)

results$scenario=1

write_csv(results, 'results_scenario1_vary_hr_contin.csv')



```




Scenario #2: Survival times are exponentially distributed from an index date. Genomic testing times are normally distributed around survival times (so genomic testing sometimes occurs before death, and sometimes it does not). This yields consistently positive conditional Kendall's tau statistics; consistently negative Cox coefficients for time to testing; underestimates of survival time; and biased biomarker effects.
```{r, fig.show='hold', message=FALSE,  fig.keep='all'}
# Scenario #2

oldw <- getOption("warn")
options(warn = -1)

cl = makeCluster(detectCores() - 1)
registerDoParallel(cl)

num_cohorts = 100000

results = foreach(i =c(1:num_cohorts), .export=ls(.GlobalEnv), .packages=c('dplyr','foreach','survival','tranSurv','depend.truncation')) %dopar% {

  hazard_rate = runif(1, min=0.005, max=0.03)
  std_dev = runif(1, min=1, max=10)
  
  num_patients_per_cohort = as.integer(runif(1, min=50, max=5000))
  
  
  biomarker_rate_ratio = runif(1, min=0.1, max=3)
  biomarker_prevalence=runif(1,0.05,0.5)
  biomarker_statuses = rbinom(num_patients_per_cohort, 1, biomarker_prevalence)

  
  
  final_rates = hazard_rate + hazard_rate*biomarker_statuses*biomarker_rate_ratio
  
  
  surv_times = rexp(num_patients_per_cohort, rate=final_rates)
  testing_times = rnorm(num_patients_per_cohort, surv_times, sd=std_dev)
  testing_times = pmax(0, testing_times)

  censoring_times = runif(num_patients_per_cohort, 0, 120)
  
  died = ifelse(surv_times < censoring_times, 1, 0)
  surv_times = pmin(surv_times, censoring_times)

  
  
  
  observed_surv_times = surv_times[surv_times > testing_times]
  observed_died = died[surv_times > testing_times]
  observed_testing_times = testing_times[surv_times > testing_times]
  observed_biomarker_statuses = biomarker_statuses[surv_times > testing_times]


  #do_copula=FALSE
  #do_transurv=FALSE
  do_copula = ifelse(runif(1) < 0.10, TRUE, FALSE)
  do_transurv = ifelse(runif(1) < 0.10, TRUE, FALSE)
  
    bind_cols(num_patients_per_cohort=num_patients_per_cohort, num_patients_observed=length(observed_died), hazard_rate=hazard_rate, std_dev=std_dev, biomarker_rate_ratio=biomarker_rate_ratio, biomarker_prevalence=biomarker_prevalence, eval_simple(surv_times = surv_times, died=died, testing_times=testing_times, observed_surv_times = observed_surv_times, observed_died=observed_died, observed_testing_times = observed_testing_times, biomarker_statuses = biomarker_statuses, observed_biomarker_statuses = observed_biomarker_statuses, do_transurv = do_transurv, do_copula = do_copula))
  
}

registerDoSEQ()  
stopCluster(cl)


options(warn = oldw)

results = bind_rows(results)

results$scenario=2

write_csv(results, 'results_scenario2_vary_hr_contin.csv')


```











Scenario #3: Survival times are exponentially distributed from an index date. However, each cohort contains two subgroups. In the first subgroup, genomic testing times are uniformly distributed over the first three months following the index date. In the second subgroup, genomic testing times are normally distributed around survival times (as was done for scenario #1). In the resulting heterogeneous cohorts, conditional Kendall's tau statistics are consistently negative; Cox coefficients for time are consistently positive; survival times are underestimated; and observed biomarker effects are biased.

```{r, fig.show='hold', message=FALSE,  fig.keep='all'}
# Scenario #3

oldw <- getOption("warn")
options(warn = -1)

cl = makeCluster(detectCores() - 1)
registerDoParallel(cl)

num_cohorts = 100000

results = foreach(i =c(1:num_cohorts), .export=ls(.GlobalEnv), .packages=c('dplyr','foreach','survival','tranSurv','depend.truncation')) %dopar% {
 # here
  hazard_rate = runif(1, 0.005, 0.03)
  proportion_early = runif(1, 0.001, 0.95)
  std_dev = runif(1, 1, 10)
  
  num_patients_per_cohort = as.integer(runif(1, min=50, max=5000))
  
  
  biomarker_rate_ratio = runif(1, min=0.1, max=3)
  biomarker_prevalence = runif(1, 0.05, 0.5)
  biomarker_statuses = rbinom(num_patients_per_cohort, 1, biomarker_prevalence)
  final_surv_rates = hazard_rate + hazard_rate*biomarker_statuses*biomarker_rate_ratio

  num_early_patients = as.integer(num_patients_per_cohort*proportion_early)
  num_late_patients = num_patients_per_cohort - num_early_patients
  
  early_cohort_testing_times = runif(num_early_patients, min=0, max=3)
  early_cohort_survival_times = rexp(num_early_patients, final_surv_rates[1:num_early_patients])
  
  
  late_cohort_survival_times = rexp(num_late_patients, final_surv_rates[num_early_patients+1:num_patients_per_cohort])
  late_cohort_testing_times = rnorm(num_late_patients, late_cohort_survival_times, std_dev)
  
  surv_times = c(early_cohort_survival_times, late_cohort_survival_times)
  testing_times = c(early_cohort_testing_times, late_cohort_testing_times)
  testing_times = pmax(0, testing_times)
  
  censoring_times = runif(num_patients_per_cohort, 0, 120)
  
  died = ifelse(surv_times < censoring_times, 1, 0)
  surv_times = pmin(surv_times, censoring_times)
  
  observed_surv_times = surv_times[surv_times > testing_times]
  observed_died = died[surv_times > testing_times]
  observed_testing_times = testing_times[surv_times > testing_times]
  observed_biomarker_statuses = biomarker_statuses[surv_times > testing_times]

  #do_copula = FALSE
  #do_transurv = FALSE
  do_copula = ifelse(runif(1) < 0.10, TRUE, FALSE)
  do_transurv = ifelse(runif(1) < 0.10, TRUE, FALSE)

    bind_cols(num_patients_per_cohort=num_patients_per_cohort, num_patients_observed=length(observed_died), hazard_rate=hazard_rate, std_dev=std_dev, proportion_early=proportion_early, biomarker_rate_ratio=biomarker_rate_ratio, biomarker_prevalence=biomarker_prevalence, eval_simple(surv_times = surv_times, died=died, testing_times=testing_times, observed_surv_times = observed_surv_times, observed_died=observed_died, observed_testing_times = observed_testing_times, biomarker_statuses = biomarker_statuses, observed_biomarker_statuses = observed_biomarker_statuses, do_transurv = do_transurv, do_copula = do_copula))
  
}

registerDoSEQ()  
stopCluster(cl)


options(warn = oldw)

results = bind_rows(results)

results$scenario=3

write_csv(results, 'results_scenario3_vary_hr_contin.csv')

```



Scenario 4: A latent exponentially distributed time to cancer progression is simulated. Next, times from progression to mortality and from progression to genomic testing are calculated, with each following its own exponential distribution indexed at progression. This yield basically any values for the conditional Kendall's tau statistic and Cox coefficient for time, including null values, depending on the relationship between progression hazard and mortality hazard. This always yields underestimates of survival time. It also yields observed Cox biomarker coefficients that are different from the "true" values calculated for this cohort, though interestingly the observed Cox biomarker coefficients for Scenario 3 correspond to the true values obtained in other scenarios.

```{r, fig.show='hold', message=FALSE,  fig.keep='all'}
# Scenario #4

oldw <- getOption("warn")
options(warn = -1)

cl = makeCluster(detectCores() - 1)
registerDoParallel(cl)

num_cohorts = 100000

results = foreach(i =c(1:num_cohorts), .export=ls(.GlobalEnv), .packages=c('dplyr','foreach','survival','tranSurv','depend.truncation')) %dopar% {


  num_patients_per_cohort = as.integer(runif(1, min=50, max=5000))
  
  
  biomarker_rate_ratio = runif(1, min=0.1, max=3)
  biomarker_prevalence = runif(1,0.05,0.5)
  biomarker_statuses = rbinom(num_patients_per_cohort, 1, biomarker_prevalence)
  
  
  progression_rate = runif(1, min=0.005, max=0.03)
  testing_rate = runif(1, min=0.005, max=0.03)
  hazard_rate = runif(1, min=0.005, max=0.03)
  
  
  
  final_progression_rates = progression_rate + progression_rate*biomarker_statuses*biomarker_rate_ratio
  final_surv_rates = hazard_rate + hazard_rate*biomarker_statuses*biomarker_rate_ratio
  
  
  
  progression_times = rexp(num_patients_per_cohort, rate=final_progression_rates)
  testing_times = progression_times + rexp(num_patients_per_cohort, rate = testing_rate)
  testing_times = pmax(0, testing_times)
  surv_times = progression_times + rexp(num_patients_per_cohort, final_surv_rates)
  
  censoring_times = runif(num_patients_per_cohort, 0, 120)
  
  
  
  died = ifelse(surv_times < censoring_times, 1, 0)
  surv_times = pmin(surv_times, censoring_times)
  
  observed_surv_times = surv_times[surv_times > testing_times]
  observed_died = died[surv_times > testing_times]
  observed_testing_times = testing_times[surv_times > testing_times]
  observed_biomarker_statuses = biomarker_statuses[surv_times > testing_times]

  do_copula = ifelse(runif(1) < 0.10, TRUE, FALSE)
  do_transurv = ifelse(runif(1) < 0.10, TRUE, FALSE)

    bind_cols(num_patients_per_cohort=num_patients_per_cohort, num_patients_observed=length(observed_died), hazard_rate=hazard_rate,  biomarker_rate_ratio=biomarker_rate_ratio, biomarker_prevalence=biomarker_prevalence, progression_rate=progression_rate, testing_rate=testing_rate, eval_simple(surv_times = surv_times, died=died, testing_times=testing_times, observed_surv_times = observed_surv_times, observed_died=observed_died, observed_testing_times = observed_testing_times, biomarker_statuses = biomarker_statuses, observed_biomarker_statuses = observed_biomarker_statuses, do_transurv = do_transurv, do_copula = do_copula))
  
}

registerDoSEQ()  
stopCluster(cl)


options(warn = oldw)

results = bind_rows(results)

results$scenario=4

write_csv(results, 'results_scenario4_vary_hr_contin.csv')




```

